apiVersion: v1
kind: Namespace
metadata:
  name: px-preflight
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: px-preflight-sa
  namespace: px-preflight
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: px-preflight-role
  namespace: px-preflight
rules:
  - apiGroups: [""]
    resources:
      - pods
    verbs:
      - get
      - list
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: px-preflight-rb
  namespace: px-preflight
subjects:
  - kind: ServiceAccount
    name: px-preflight-sa
roleRef:
  kind: Role
  name: px-preflight-role
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: px-preflight-cr
rules:
- apiGroups: [""]
  resources:
  - nodes
  verbs:
  - get
  - list
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: px-preflight-crb
subjects:
- kind: ServiceAccount
  name: px-preflight-sa
  namespace: px-preflight
roleRef:
  kind: ClusterRole
  name: px-preflight-cr
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres
  namespace: px-preflight
spec:
  selector:
    matchLabels:
      app: postgres
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
    type: RollingUpdate
  replicas: 1
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
      - name: postgres
        image: px-preflight
        imagePullPolicy: "Never"
        ports:
        - containerPort: 5432
        command:
        - "su"
        - "-"
        - "postgres"
        - "-c"
        - "/usr/lib/postgresql/12/bin/postgres -c config_file=/etc/postgresql/12/main/postgresql.conf -h '*'"
        readinessProbe:
          exec:
            command: ["psql", "-U", "postgres", "-c", "SELECT 1"]
          initialDelaySeconds: 1
          timeoutSeconds: 2
          periodSeconds: 5
        livenessProbe:
          exec:
            command: ["psql", "-U", "postgres", "-c", "SELECT 1"]
          initialDelaySeconds: 1
          timeoutSeconds: 2
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: postgres
  namespace: px-preflight
spec:
  selector:
    app: postgres
  ports:
    - protocol: TCP
      port: 5432
      targetPort: 5432
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  namespace: px-preflight
spec:
  selector:
    matchLabels:
      app: nginx
  strategy:
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 1
    type: RollingUpdate
  replicas: 1
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: px-preflight
        imagePullPolicy: "Never"
        ports:
        - containerPort: 80
        command:
        - "nginx"
        - "-g"
        - "daemon off;"
        readinessProbe:
          httpGet:
            port: 80
            path: /index.html
          initialDelaySeconds: 1
          periodSeconds: 5
          timeoutSeconds: 1
        livenessProbe:
          httpGet:
            port: 80
            path: /index.html
          initialDelaySeconds: 1
          periodSeconds: 5
          timeoutSeconds: 1
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: scripts
  namespace: px-preflight
data:
  initdb.sh: |-
    export PGUSER=postgres
    export PGDATABASE=px-preflight
    export PGHOST=postgres.px-preflight.svc
    while ! createdb -EUTF8; do
      echo waiting for postgresql
      sleep 1
    done
    psql <<EOF
    CREATE TABLE nodes (
      id SERIAL PRIMARY KEY,
      ip TEXT UNIQUE NOT NULL,
      name TEXT UNIQUE NOT NULL,
      skew INTEGER,
      swap INTEGER,
      cores INTEGER,
      var_free INTEGER,
      opt_free INTEGER,
      kernel TEXT
    );
    CREATE TABLE etcd_nodes (
      id SERIAL PRIMARY KEY,
      ip TEXT NOT NULL,
      port INTEGER NOT NULL
    );
    CREATE TABLE latency (
      source_id INTEGER UNIQUE NOT NULL REFERENCES nodes (id),
      dest_id INTEGER UNIQUE NOT NULL REFERENCES nodes (id),
      time INTEGER NOT NULL
    );
    CREATE TABLE tcp (
      source_id INTEGER UNIQUE NOT NULL REFERENCES nodes (id),
      dest_id INTEGER UNIQUE NOT NULL REFERENCES nodes (id),
      open BOOLEAN NOT NULL,
      port INTEGER NOT NULL
    );
    CREATE TABLE udp (
      source_id INTEGER UNIQUE NOT NULL REFERENCES nodes (id),
      dest_id INTEGER UNIQUE NOT NULL REFERENCES nodes (id),
      open BOOLEAN NOT NULL,
      port INTEGER NOT NULL
    );
    CREATE TABLE etcd_conn (
      node_id INTEGER NOT NULL REFERENCES nodes (id),
      etcd_id INTEGER NOT NULL REFERENCES etcd_nodes (id),
      open BOOLEAN NOT NULL
    );
    CREATE TABLE disks (
      node_id INTEGER NOT NULL REFERENCES nodes (id),
      file TEXT NOT NULL,
      size INTEGER NOT NULL
    );
    CREATE UNIQUE INDEX latency_idx ON latency (source_id, dest_id);
    CREATE UNIQUE INDEX etcd_idx ON etcd_nodes (ip, port);
    CREATE UNIQUE INDEX tcp_idx ON tcp (source_id, dest_id, port);
    CREATE UNIQUE INDEX udp_idx ON udp (source_id, dest_id, port);
    CREATE UNIQUE INDEX disk_idx ON disks (node_id, file);
    EOF
  px-preflight.sh: |-
    sleep 30
---
apiVersion: batch/v1
kind: Job
metadata:
  name: initdb
  namespace: px-preflight
spec:
  template:
    metadata:
      name: initdb
      labels:
        app: initdb
    spec:
      containers:
      - name: initdb
        image: px-preflight
        imagePullPolicy: "Never"
        command: [ "/bin/sh", "/initdb.sh" ]
        volumeMounts:
        - name: initdb
          mountPath: /initdb.sh
          subPath: initdb.sh
      volumes:
      - name: initdb
        configMap:
          name: scripts
      restartPolicy: OnFailure
---
apiVersion: batch/v1
kind: Job
metadata:
  name: px-preflight
  namespace: px-preflight
spec:
  completions: 3
  parallelism: 3
  template:
    metadata:
      name: px-preflight
      labels:
        app: px-preflight
    spec:
      containers:
      - name: px-preflight
        image: px-preflight
        imagePullPolicy: "Never"
        command: [ "/bin/sh", "/px-preflight.sh" ]
        volumeMounts:
        - name: px-preflight
          mountPath: /px-preflight.sh
          subPath: px-preflight.sh
      volumes:
      - name: px-preflight
        configMap:
          name: scripts
      restartPolicy: Never
      affinity:
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: "app"
                    operator: In
                    values:
                    - px-preflight
              topologyKey: "kubernetes.io/hostname"
